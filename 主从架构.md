# 主从架构

1. ### 什么是主从复制架构？

   <img src="D:\content\markdoc\imgs\主从复制架构.png" style="zoom:67%;" />

   1. 让主节点可复制数据到从节点，保证主从数据的基本一致性
   2. 主节点宕机还可以从从节点执行SQL，保证高可用性
   3. 如长查询SQL，可专用一个库进行查询

2. ### 读写分离架构

   1. 主节点写入数据，但从从节点进行数据查询
   2. 一台专用来写入数据，其他的从节点进行数据查询

3. ### 主从复制工作原理

   1. MySQL在执行增删改的时候会记录binlog日志
   2. 从库有一个IO线程，会负责跟主库建立一个TCP连接，请求主库传输binlog日志给自己
   3. 主库上有一个dump线程，负责通过这个TCP连接把binlog日志输入给从库IO线程
   4. 从库会将binlog日志写入到自己本地的relay日志文件中去
   5. 从库另外有一线程，会读取relay日志里的内容。进行日志重做，即把在主库上的增删改日志都重做一遍

4. 主从架构的搭建

   1. 首先需确保几个MySQL的server-id是不一致的

   2. 主库需要打开binlog日志

   3. 创建主从复制的账号

   4. 如果此时主库跑了一段时间，则须先暂停主库，dump一份主库的分贝

      /usr/local/mysql/bin/mysqldump --single -transaction -uroot -proot --master-data=2 -A bockup.sql

      master-data = 2 意思是说备份SQL里，要记录下此时主库的binlog日志和position号，主从复制准备

   5. 将backup.sql拷贝到从库，并执行

   6. 指定从库复制

      CHANG MASTER TO MASTER = '192.168.31.11' 

      MASTER_USER='blockup' , MASTER_PASSWORD='blockup' , MASTER_LOG_FILE='mysql-bin.000015' , 

      MASTER_LOCI_POSO=1689

      - MASTER_LOG_FILE 和 MASTER_LOG_POS这两个参数在导出的bockup.sql文件头中有

   7. 执行开始复制的命令

      start slave

5. 半同步

   - 上述存在的问题： 主库写完后提交，不管从库是否执行成功，万一此时binlog日志还未同步，主库即宕机，会导致数据丢失
   - 半同步机制：
     - 起码让主库将binlog日志同步给从库才提交事务
   - 两种方式实现
     - AFTER_COMMIT: 主库写入binlog日志后，等待其复制到从库了，就提交自己的事务。等待从库返回成功之后，然后再响应给客户端
     - 默认 ： 主库写入binlog日志后，复制给从库，然后开始等待从库响应。响应成功后主库提交事务，然后返回响应给客户端

6. 半同步配置：

   1. 主库先装插件： 

      install plugin rpl_semi_sync_master soname 'semisync_master_so' 

      set global rpl_semi_sync_master_enable = on

      show plugins

   2. 从库装插件

      install plugin rpl_semi_synv_slave soname 'semisync_slave.so'

      set global rpl_semi_sync_slave_enable = on

   3. 重启从库的IO线程

      stop slave io-thread ; start is-thread

   4. 主库上检查半同步是否同步

      show global status like '%semi%'

7. 基于GTID搭建半复制模式

   1. 主库

      gtid_mode = on

      enforce_gtid_consistency=on

      log_bin = on

      server_id = 自己的server_id

   2. 从库

      gtid_mode = on

      enforce_gtid_consistency = on

      log_slave_update = 1

      server_id = 自己的server_id

## 主从存在的问题

1. ### 为什么会产生延迟?

   1. 