# MySQL索引

## 索引的物理结构

1. ### 数据页是怎么存储的？

   <img src="D:\content\markdoc\imgs\数据页存储结构.png" style="zoom:67%;" />

   1. 数据页都是放在磁盘文件中
   2. 数据页的两两相邻间采用双向链表连接
   3. 数据页就是一段数据，可能是二进制，或者是别的特殊格式，包含两个指针，一个指向上一个物理页，一个指向下一个物理页
   4. 数据行是根据主键大小由小到大进行排列的
   5. 每个数据页都有一个页目录，里面根据数据行主键存放了一个目录，同时数据行是被分散到不同槽位里去的
   
2. ### 仅有一个数据页如何寻找到数据？

   1. 根据主键进行查找的时候

      会先到数据页目录里根据主键进行二分查找，然后定位到具体哪个槽位，相应的读取那行数据即可

   2. 非主键查找的时候

      只能根据链表去遍历数据页的每一行数据

3. ### 多个数据页的情况下，如何进行查找？

   1. 根据主键进行查找的时候，根据二分查找法进行查找
   2. 不根据主键的时候，都是如上所示，根据链表进行遍历。从第一个数据页开始，从磁盘中读取到Buffer pool缓存中，如果没有则继续加载下一页。

4. ### 页分裂过程？

   <img src="D:\content\markdoc\imgs\页分裂过程.png" style="zoom:50%;" />

   1. 页的结构
      - 页的最开始的一行是起始行，数据类型为2，即页中最小的一行，有指针指向下一行
      - 普通行的数据类型为0，每一行都有 数据类型、id、指针、数据值这四个东西，通过指针不断的指向下一行
      - 末尾行的类型为3
   2. 页分裂过程
      1. 索引运行基础： 后一个数据也的id值都大于前一个数据页的主键值
      2. 当插入一条数据时，如上图所示，新建的一个数据页的id值是小于上一页的最大id值的，所以此时要进行页分裂
      3. 即在插入新的数据页如果无法保证顺序，则进行页分裂。
      4. 将上一个数据页id的大值，挪到后一个数据页中，将较小的id值挪到前一页中

5. ### 基于主键索引的查询设计

   ![](D:\content\markdoc\imgs\索引页建立过程.png)

   - 每个数据页都有页目录，里面记录了主键和行的信息
   - 可根据二分查找法来寻找主键的位置，定位到具体的数据页，然后再在数据页中二分查找具体行信息
   - 索引页也是放在数据页里的
   - 当数据页过多的时候，会抽象一层数据页，保留了最小页的最小索引值和最大页的最小索引值
   - 如果索引页的下层索引由于页分页依然太多了怎么办？向上再抽象出一层索引页
   - 在上述的索引页抽离过程中，即形成了一颗B+树

## 索引的维护

1. ### 插入/更新数据的时候，如何维护聚簇索引？

   1. 索引页与数据页之间是通过指针相互连接起来的
   2. 索引页之间也是通过指针连接起来的，同一层级索引页之间组成双向链表
   3. 由于索引页是存储在数据页之中，故最底层索引页实际上是通过双向链表进行连接起来的
   4. 叶子结点存放的为数据页本身
   5. 由于这种B+树索引数据结构里，叶子结点就是数据页本身，那么此时我们就可以称这颗B+树索引为聚簇索引
   6. 如果你一直向表中insert数据，就是直接将数据页放在聚簇索引里
   7. 如果数据页进行了页分裂，此时会调整各个数据行的数据，保证主键是必须有序的
   8. 同时在页分裂时，会维护上层索引的数据结构，在上层索引中维护你的数据条目，不同数据页和最小主键的值
   9. 如若你数据页越来越多，一个索引页放不下，此时会拉出新的数据页，同时再搞一个上层索引页，存放页号和最小主键值

2. ### 针对非主键索引建立的二级索引是如何运作的？

   1. 如果你建立了一个二级索引，则会根据这个二级索引再建一颗索引树
      - 如根据name建立一个索引，B+树的叶子结点也是存放了数据页，但是这个数据页里仅包含了主键字段+name值
   2. 排序规则和之前使用主键索引的排序规则是一致的，先按被索引字段（name），如若相同则按主键进行排序
   3. 向上抽离索引页的时候，抽离的为最小name值字段
   4. 如select * from users where name='zhangsan'
      - 会先根据name字段的值，在name的B+树中找到对应的主键值
      - 然后根据主键值，再到聚簇索引的根节点开始，一路通过二分查找法找到叶子结点的数据页
      - 找到数据页之后，再通过二分查找法，找到对应的数据行
   5. 联合索引雷同，只过不叶子结点存放的为如 name+age和id的值,然后默认是按照name排序，name相同则使用age，都相同再根据主键进行排序

3. ### 数据insert的时候，是如何维护好不同索引之间的B+树？

   1. 首先有一层数据页，它是聚簇索引的一部分，也是叶子结点，默认有一个基于主键的页目录，第一个页为根页
   2. 然后页里数据越来越多，即会引发页分裂，将较大的数据拷贝到后一个数据页，将较小的数据拷贝到前一个数据页之中，重新维护主键的顺序
   3. 根页然后会升级为索引页，放的是页分裂后两个数据页号和他们各自的最小主键值
   4. 继续插入数据，当索引页的空间已经无法存放页号和最小索引页的值的时候，即会再向上抽离出根页，就形成了三层索引
   5. 当插入一条数据至二级索引（如name），会先根据name定位到插入哪一个数据页，如果name一致，但指向的页号不同，则需要根据主键去判断一下，较大的主键会到下一行

4. ### 总结

   1. 聚簇索引的叶子结点都是数据页，里面存放的是一行行数据
   2. 数据页之间是通过双向链表进行连接的，而且是有序的
   3. 如果建立二级索引，则是重新建立一颗B+树，存放的为被索引字段+主键值，根据被索引字段进行排序
   4. 二级索引假如查找非索引字段，需要回表查询数据
   5. 优点： 
      - 查询的时候，不需要全表扫描，提升性能
   6. 缺点：
      - 每颗B+树都要占用空间
      - 增删改都得额外维护二级索引，和索引的有序性
      - 一直insert会导致页分裂频繁